<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <!-- <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js" ></script> -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link rel="stylesheet" href="./index.css">


  <style>
    body { font-family: 'Prompt', sans-serif; }
    .section { display: none; }
    .section.active { display: block; }
    

   
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
  <script>
    let qrScanner;
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á client
    const supabase = window.supabase.createClient(
      "https://ukdachhtnvhoxaospqls.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrZGFjaGh0bnZob3hhb3NwcWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzNDU1NDUsImV4cCI6MjA2MDkyMTU0NX0.tHns58dgK_OgGS4YWBt7SCA3Er7Pmw9JlECEH7pt5j8"
    );

    async function loadEmployeeInfo() {
      await supabase.auth.refreshSession();
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      console.log("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å Supabase Auth:", user.email);

      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .eq('email', user.email) ; // filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ email ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      console.log(data);
      console.log("‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å DB:", data);
      console.log("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):", error);
      console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á login:", user.email);

      if (userError || !user) {
        document.getElementById('employee').innerHTML = `<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>`;
        console.error("User error:", userError);
        return;
      }
      
      if (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:", error);
        document.getElementById('employee').innerHTML = `<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>`;
        return;
      }

      if (data.length > 0) {
        const emp = data[0];
        document.getElementById('employee').innerHTML = `
          <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
          <p>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${emp.employee_id}</p>
          <p>‡∏ä‡∏∑‡πà‡∏≠: ${emp.username}</p>
          <p>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${emp.role}</p>
        `;
      } else {
        document.getElementById('employee').innerHTML = `<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>`;
      }
    }  


    async function logout() {
     const { error } = await supabase.auth.signOut();

      if (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:", error);
      } else {
        console.log("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        // ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å logout
        location.reload();
        window.location.href = "login.html"; // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà login.html ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å reload
      }
    }
    
    window.addEventListener("DOMContentLoaded", async () => {
      const { data: { user }, error } = await supabase.auth.getUser();

      if (error || !user) {
        window.location.href = "login.html";
        return;
      }

      await loadEmployeeInfo();
      await checkAdminMenu();
    });

    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'long', year: 'numeric', month: 'long',
        day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      };
      const datetimeStr = now.toLocaleString('th-TH', options);
      document.getElementById('datetime').textContent = `üïí ${datetimeStr}`;
    }
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setInterval(updateDateTime, 1000);
    updateDateTime();

    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(link => {
        if (link.getAttribute('onclick')?.includes(id)) link.classList.add('active');
      });
    }


    async function checkAdminMenu() {
      const { data: { user } } = await supabase.auth.getUser();

      const { data: emp, error } = await supabase
        .from("employees")
        .select("special_role")
        .eq("email", user.email)
        .single();

        if (emp && emp.special_role === 'admin') {
          document.getElementById("admin-menu").style.display = "block";
        }
    }


    function startScan() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ qrScanner ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      if (!qrScanner) {
        qrScanner = new Html5Qrcode("qr-reader"); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Element ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
      }

      qrScanner.start(
        { facingMode: "environment" }, // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
        {
          fps: 10, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (frame per second)
          qrbox: { width: 250, height: 250 } // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡πÅ‡∏Å‡∏ô
        },
        async (decodedText, decodedResult) => {
          console.log("QR ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ:", decodedText);
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR Code ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
          if (decodedText === `qr-code-check-in-${new Date().toISOString().split('T')[0]}`) {
          await saveCheckin();
          await qrScanner.stop();
          document.getElementById("qr-result").textContent = "‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        } else {
          document.getElementById("qr-result").textContent = "‚ùå QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        }
        },
        (errorMessage) => {
          console.warn("‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", errorMessage); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        }
      ).catch(err => {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô:", err); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
      });
      
    }

    function stopScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          console.log("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
          document.getElementById("qr-result").textContent = "‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ñ‡∏π‡∏Å‡∏´‡∏¢‡∏∏‡∏î";
        }).catch((err) => {
          console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô:", err);
        });
      }
    }


    async function saveCheckin() {
      const { data: userData } = await supabase.auth.getUser();
      const email = userData.user.email;

      const { data: empData, error: empErr } = await supabase
        .from("employees")
        .select("employee_id")
        .eq("email", email)
        .single(); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

      if (empErr || !empData) {
        document.getElementById("qr-result").innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
        return;
      }

      const res = await supabase.from("attendence_log").insert([
        {
          check_type: "check-in",
          timestamp: new Date().toISOString(),
          location: "office",
          employee_id: empData.employee_id
        }
      ]);

      if (res.error) {
        document.getElementById("qr-result").textContent = "‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      }
    }

    function startScanCheckout() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ qrScanner ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      if (!qrScanner) {
        qrScanner = new Html5Qrcode("qr-reader-checkout"); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Element ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
      }

      qrScanner.start(
        { facingMode: "environment" }, // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
        {
          fps: 10, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (frame per second)
          qrbox: { width: 250, height: 250 } // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡πÅ‡∏Å‡∏ô
        },
        async (decodedText, decodedResult) => {
          console.log("QR ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ:", decodedText);
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR Code ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
          if (decodedText === `qr-code-check-out-${new Date().toISOString().split('T')[0]}`) {
            await saveCheckout();
            await qrScanner.stop();
            document.getElementById("qr-result").textContent = "‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
          } else {
            document.getElementById("qr-result").textContent = "‚ùå QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
          }
        },
        (errorMessage) => {
          console.warn("‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", errorMessage); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        }
      ).catch(err => {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô:", err); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
      });
    }

    function toggleQRCode(type) {
      const qrDiv = document.getElementById(`${type}-qr`);
      
      // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á QR Code
      if (qrDiv.style.display === 'none') {
        // ‡∏ñ‡πâ‡∏≤ QR Code ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
        generateQRCode(type);
        qrDiv.style.display = 'block';
      } else {
        // ‡∏ñ‡πâ‡∏≤ QR Code ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
        qrDiv.style.display = 'none';
      }
    }

    function generateQRCode(type) {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0]; // ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
      
      let codeData;
      if (type === 'check-in') {
        codeData = `qr-code-check-in-${dateStr}`; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
      } else if (type === 'check-out') {
        codeData = `qr-code-check-out-${dateStr}`; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
      }

      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${codeData}`;
      document.getElementById(`${type}-qr`).innerHTML = `
        <h5>QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ ${type === 'check-in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'}:</h5>
        <img src="${qrCodeUrl}" />`;
    }


    function generateCheckInQRCode() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0]; // ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
      const checkInCode = `qr-code-check-in-${dateStr}`; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô

      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${checkInCode}`;
      document.getElementById("check-in-qr").innerHTML = `
      <h5>QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô:</h5>
      <img src="${qrCodeUrl}" />`;
    }

    function generateCheckOutQRCode() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0]; // ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
      const checkOutCode = `qr-code-check-out-${dateStr}`; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå

      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${checkOutCode}`;
      document.getElementById("check-out-qr").innerHTML = `
      <h5>QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô:</h5>
      <img src="${qrCodeUrl}" />`;
    }

    async function viewAttendanceLog() {
      const { data, error } = await supabase.from("attendence_log").select("*").order("timestamp", { ascending: false });

      const logDiv = document.getElementById("attendance-log");
      if (error) {
        logDiv.innerHTML = `<p class="text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>`;
        return;
      }

      let html = "<ul class='list-group'>";
      data.forEach(log => {
        html += `<li class='list-group-item'>
          üßæ ${log.employee_id} - ${log.check_type} @ ${new Date(log.timestamp).toLocaleString("th-TH")}
        </li>`;
      });
      html += "</ul>";
      logDiv.innerHTML = html;
    }    
  </script>
  

</head>
<body>
  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <body> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
<div class="d-flex">
  <!-- üîπ Sidebar -->
  <div id="sidebar" class="bg-success text-white p-3" style="min-width: 250px; height: 100vh; position: fixed;">
    <h4 class="mb-4">‡πÄ‡∏°‡∏ô‡∏π</h4>
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('home')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('checkin')">üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('checkout')">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('calendar-page')">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('notifications')">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('payroll')">üí∏ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</a></li>
      <li id="admin-menu" class="nav-item" style="display:none;">
        <a class="nav-link text-white" href="#" onclick="showSection('admin')">üõ† ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</a>
      </li>
    </ul>
    <button class="btn btn-light mt-4" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <!-- üîπ Main Content -->
  <div style="margin-left:250px; width:100%;">
    <!-- ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
    <div class="container py-4">
      <div id="home" class="section active">
        <h2>üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2>
        <div id="employee">
          <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</h2>
        </div>
        <div id="datetime" class="mb-3 text-muted"></div>
        <div class="mb-3 d-flex flex-column justify-content-center align-items-center gap-2">
          <button class="btn btn-success w-50" onclick="showSection('checkin')">üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤</button>
          <button class="btn btn-danger w-50" onclick="showSection('checkout')">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å</button>
        </div>        
        <div class="mb-4">
          <h5>üîó ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h5>
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="showSection('calendar-page')">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
            <button class="btn btn-outline-warning" onclick="showSection('notifications')">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
            <button class="btn btn-outline-info" onclick="showSection('payroll')">üí∏ ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
          </div>
        </div>
      </div>
      
      <div id="checkin" class="section">
        <h2>üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</h2>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</p>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô -->
        <button class="btn btn-success mt-3" onclick="startScan()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏Å‡∏ô</button>
        <button class="btn btn-danger mt-3" onclick="stopScan()">‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏™‡∏Å‡∏ô</button>
        <div id="qr-reader" style="width:300px;height:300px;"></div>
        <div id="qr-result" class="mt-3 text-center text-success fw-bold"></div>
      </div>

      <div id="checkout" class="section">
        <h2>üî¥ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</h2>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</p>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô -->
        <button class="btn btn-success mt-3" onclick="startScanCheckout()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏Å‡∏ô</button>
        <button class="btn btn-danger mt-3" onclick="stopScan()">‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏™‡∏Å‡∏ô</button>
        <div id="qr-reader-checkout" style="width:300px;height:300px;"></div>
        <div id="qr-result" class="mt-3 text-center text-success fw-bold"></div>
      </div>

      <div id="calendar-page" class="section">
        <h2>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
        <div id="calendar"></div>
      
        <script>
          document.addEventListener('DOMContentLoaded', async function () {
    const calendarEl = document.getElementById('calendar');

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supabase
    const { data, error } = await supabase
      .from('day_types') // ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô
      .select('*'); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    if (error) {
      console.error('Error fetching data:', error);
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö {date: [types]}
    const dayTypes = {};
    data.forEach(item => {
      const dateStr = item.date; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö FullCalendar
      if (!dayTypes[dateStr]) {
        dayTypes[dateStr] = [];
      }
      dayTypes[dateStr].push(item.type); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô (workday, leave, holiday)
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô FullCalendar
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'th', // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
      initialDate: new Date(), // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      height: 'auto',
      dayCellContent: function (arg) {
        let dateStr = arg.date.toISOString().split('T')[0]; // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô string
        let dots = '';  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dots

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (dayTypes[dateStr]) {
          dots += `<div class="dots-container">`;  // ‡∏™‡∏£‡πâ‡∏≤‡∏á container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dots
          dayTypes[dateStr].forEach(type => {
            dots += `<span class="dot ${type}"></span>`;  // ‡πÄ‡∏û‡∏¥‡πà‡∏° dot ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
          });
          dots += `</div>`;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ dots ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        return { html: `<div>${arg.date.getDate()}${dots}</div>` };
      }
    });

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
    calendar.render();
  });
        </script>
      </div>
      
      
      

      <div id="notifications" class="section"><h2>üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2></div>
      <div id="payroll" class="section"><h2>üí∏ ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2></div>
      <div id="admin" class="section">
        <h2>üõ† ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        <div class="mb-4">
          <h4>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
          <button class="btn btn-outline-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
          <button class="btn btn-outline-warning">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button class="btn btn-outline-danger">üóëÔ∏è ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="mb-4">
          <h4>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</h4>
          <button class="btn btn-outline-secondary" onclick="viewAttendanceLog()">üìÖ ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
          <div id="attendance-log"></div>
        </div>

        <div class="mb-4">
          <h4>üì¶ QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
          <button class="btn btn-outline-success" onclick="toggleQRCode('check-in')">üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          </button>
          <button class="btn btn-outline-danger" onclick="toggleQRCode('check-out')">üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
          <div id="today-qr" class="mt-4">
            <div id="check-in-qr" style="display: none;"></div>
            <div id="check-out-qr" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- üîπ Section: Calendar -->
  <!-- <div id="calendar" class="section">
    <h2>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
    <iframe src="https://calendar.google.com/calendar/embed?src=th.th%23holiday%40group.v.calendar.google.com&ctz=Asia%2FBangkok"
      style="border: 0" width="100%" height="500" frameborder="0" scrolling="no"></iframe>
  </div> -->
    
</body>
</html>
